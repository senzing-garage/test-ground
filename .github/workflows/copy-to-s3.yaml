# Based on
# - https://docs.github.com/en/actions/guides/adding-labels-to-issues
# - https://github.com/andymckay/labeler

# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Copy CFTs to S3
on:
  release:
    types:
      - published
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: check the file list
      run: ls -al # list the files for confirmation.
    - name: pwd
      run: pwd
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.SENZING_AWS_ACCESS_KEY }}
        aws-secret-access-key: ${{ secrets.SENZING_AWS_ACCESS_SECRET }}
        aws-region: us-east-1
        role-duration-seconds: 1200
        role-session-name: MySessionName
#        role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
#        role-external-id: ${{ secrets.AWS_ROLE_EXTERNAL_ID }}
    - name: Get the version
      id: get_version
      run: echo ::set-output name=VERSION::${GITHUB_REF/refs\/tags\//}
    - name: Copy cloudformation-senzing-basic.yaml to S3
      run: aws s3 cp cloudformation-senzing-basic.yaml s3://${{ secrets.SENZING_AWS_MARKETPLACE_BUCKET_NAME }}/test.yaml

#      env:
#        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
#        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#        AWS_DEFAULT_REGION: 'ap-south-1'

#    - run: echo ${{ steps.get_version.outputs.VERSION }}
#    - name: Copy cloudformation-senzing-basic.yaml to S3
#      run: bash .github/workflows/copy-to-s3.sh ${{secrets.SENZING_AWS_MARKETPLACE_BUCKET_NAME}} "basic/test.yaml" ${{secrets.SENZING_AWS_ACCESS_KEY}} ${{secrets.SENZING_AWS_ACCESS_SECRET}} "cloudformation-senzing-basic.yaml"
#      run: bash scripts/pipeline/release.sh ${{secrets.SENZING_AWS_MARKETPLACE_BUCKET_NAME}} "basic/cloudformation-senzing-basic.yaml" ${{secrets.SENZING_AWS_ACCESS_KEY}} ${{secrets.SENZING_AWS_ACCESS_SECRET}} "cloudformation-senzing-basic.yaml"
#    - name: Copy cloudformation-senzing-basic.yaml to S3 with release
#      run: bash scripts/pipeline/release.sh ${{secrets.SENZING_AWS_MARKETPLACE_BUCKET_NAME}} "basic/cloudformation-senzing-basic.yaml" ${{secrets.SENZING_AWS_ACCESS_KEY}} ${{secrets.SENZING_AWS_ACCESS_SECRET}} "cloudformation-senzing-basic.yaml"
