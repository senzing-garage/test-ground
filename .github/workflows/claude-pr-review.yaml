name: PR Review Checklist

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Get PR diff
        id: diff
        run: |
          gh pr diff ${{ github.event.pull_request.number }} > pr_diff.txt
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Review with Claude
        run: |
          python3 << 'EOF'
          import os
          import json
          import urllib.request

          with open('pr_diff.txt', 'r') as f:
              diff = f.read()

          prompt = f"""Review this PR against our team checklist:

          ## Code Quality
          - [ ] Code follows our style guide
          - [ ] No commented-out code
          - [ ] Meaningful variable names
          - [ ] DRY principle followed

          ## Testing
          - [ ] Unit tests for new functions
          - [ ] Integration tests for new endpoints
          - [ ] Edge cases covered
          - [ ] Test coverage > 80%

          ## Documentation
          - [ ] README updated if needed
          - [ ] API docs updated
          - [ ] Inline comments for complex logic
          - [ ] CHANGELOG.md updated

          ## Security
          - [ ] No hardcoded credentials
          - [ ] Input validation implemented
          - [ ] Proper error handling
          - [ ] No sensitive data in logs

          PR diff:
          ```
          {diff[:50000]}
          ```

          Provide a summary with ✅/❌ for each category."""

          data = {
              "model": "claude-sonnet-4-20250514",
              "max_tokens": 4096,
              "messages": [{"role": "user", "content": prompt}]
          }

          req = urllib.request.Request(
              'https://api.anthropic.com/v1/messages',
              data=json.dumps(data).encode('utf-8'),
              headers={
                  'Content-Type': 'application/json',
                  'Authorization': f'Bearer {os.environ["CLAUDE_CODE_OAUTH_TOKEN"]}',
                  'anthropic-version': '2023-06-01'
              }
          )

          with urllib.request.urlopen(req) as response:
              result = json.loads(response.read())
              with open('review.txt', 'w') as f:
                  f.write(result['content'][0]['text'])
          EOF
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

      - name: Post review
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "$(cat review.txt)"
        env:
          GH_TOKEN: ${{ github.token }}
  
